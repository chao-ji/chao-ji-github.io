<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Understanding ROI Align | SuperComputer’s Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Understanding ROI Align" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In the previous post we talked about bilinear interpolation algorithm. In this post we’ll see its application in ROI Align, which is a technique based on bilinear interpolation to smoothly crop a patch from a full-image feature map based on a region proposal, and then resize the cropped patch to a desired spatial size. It was introduced in the Mask R-CNN model, and has been shown to outperform the alternative that does “harsh crop” (i.e. ROI Pooling)." />
<meta property="og:description" content="In the previous post we talked about bilinear interpolation algorithm. In this post we’ll see its application in ROI Align, which is a technique based on bilinear interpolation to smoothly crop a patch from a full-image feature map based on a region proposal, and then resize the cropped patch to a desired spatial size. It was introduced in the Mask R-CNN model, and has been shown to outperform the alternative that does “harsh crop” (i.e. ROI Pooling)." />
<link rel="canonical" href="http://localhost:4000/jekyll/update/2018/07/20/ROIAlign.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/update/2018/07/20/ROIAlign.html" />
<meta property="og:site_name" content="SuperComputer’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-20T15:12:53+08:00" />
<script type="application/ld+json">
{"description":"In the previous post we talked about bilinear interpolation algorithm. In this post we’ll see its application in ROI Align, which is a technique based on bilinear interpolation to smoothly crop a patch from a full-image feature map based on a region proposal, and then resize the cropped patch to a desired spatial size. It was introduced in the Mask R-CNN model, and has been shown to outperform the alternative that does “harsh crop” (i.e. ROI Pooling).","@type":"BlogPosting","url":"http://localhost:4000/jekyll/update/2018/07/20/ROIAlign.html","headline":"Understanding ROI Align","dateModified":"2018-07-20T15:12:53+08:00","datePublished":"2018-07-20T15:12:53+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/update/2018/07/20/ROIAlign.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="SuperComputer's Blog" /></head>

<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">SuperComputer&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Understanding ROI Align</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-07-20T15:12:53+08:00" itemprop="datePublished">Jul 20, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In the <a href="/_site/jekyll/update/2018/07/19/BilinearResize.html">previous post</a> we talked about bilinear interpolation algorithm. In this post we’ll see its application in <strong>ROI Align</strong>, which is a technique based on bilinear interpolation to <em>smoothly</em> crop a patch from a full-image feature map based on a region proposal, and then resize the cropped patch to a desired spatial size. It was introduced in the Mask R-CNN model, and has been shown to outperform the alternative that does “harsh crop” (i.e. ROI Pooling).</p>

<p>We’ll discuss the main idea of ROI Align and provide numpy implementation. In addition, we’ll discuss how to compute its backward pass when we train a neural network that uses ROI Align.</p>

<h3 id="roi-align">ROI Align</h3>

<p>ROI Align takes as input</p>
<ul>
  <li>a feature map (e.g. 2-D array)</li>
  <li>a bounding box corresponding to a region proposal. The bounding box is represented by its coordinates <code class="highlighter-rouge">y_min</code>, <code class="highlighter-rouge">x_min</code>, <code class="highlighter-rouge">y_max</code>, <code class="highlighter-rouge">x_max</code>, where <code class="highlighter-rouge">0 &lt;= y_min &lt; y_max &lt;= 1</code> and <code class="highlighter-rouge">0 &lt;= x_min &lt; x_max &lt;= 1</code>. Note that the coordinates are normalized and denote the <em>relative</em> position w.r.t. the spatial size of the input feature map.</li>
  <li>the desired height and width of the output feature map (e.g. height=3, width=3)</li>
</ul>

<p>Given the 5x5 feature map and the red bounding box shown below, ROI Align outputs a 3x3 feature map computed from the values bounded within the red box.</p>

<p align="center">
<img src="/assets/bilinear_interpolation/feature_map.png" width="400" />
<br /> ROI Align crops a patch whose edges may not align with cell boundaries.
</p>

<p>You may wonder how we should deal with values that are <em>partially</em> shared by the cells in the red grid, since the black edges are not necessarily aligned with red edges. Actually I was very confused at the beginning when I tried to understand ROI Align, but then I realized that it may be better to think of the cells in the black and red grid as points in 2-D array, as shown below:</p>

<p align="center">
<img src="/assets/bilinear_interpolation/dots.png" width="400" />
<br /> Black dots: cells in input feature map; Red dots: cells in output feature map.
</p>

<p>First we need to map the coordinates of red points that vary in <script type="math/tex">[0.0, 1.0]</script> to coordinates that vary in <script type="math/tex">[0.0, 4.0]</script>. For example, a red point with coordinate <script type="math/tex">(0.3, 0.5)</script> is mapped to coordinate <script type="math/tex">(1.2, 2.0)</script>. Next, we compute the interpolated values of the red point based on the values of the four black points closest to it, which is exactly the bilinear interpolation problem.</p>

<h3 id="the-algorithm">The Algorithm</h3>

<p>As we have seen, the cells in the output feature map are represented as evenly-spaced points in 2-D space (red points in the figure above), so first we need to compute their coordinates. And because the coordinates of the bounding box are relative, we also need to convert them to absolute coordinates:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>where <code class="highlighter-rouge">img_height</code> and <code class="highlighter-rouge">img_width</code> are height and width of input feature map, and <code class="highlighter-rouge">height</code> and <code class="highlighter-rouge">width</code> are the desired height and width of output feature map.</p>

<p>Given the coordinate (may be fractional) <code class="highlighter-rouge">[y, x]</code> of a red point, we can find the coordinate of the upper left, upper right, lower left, lower right neighbor: <code class="highlighter-rouge">[y_l, x_l]</code>, <code class="highlighter-rouge">[y_l, x_h]</code>, <code class="highlighter-rouge">[y_h, x_l]</code>, <code class="highlighter-rouge">[y_h, x_h]</code></p>

<p>where</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_l</span><span class="p">,</span> <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>
<span class="n">x_l</span><span class="p">,</span> <span class="n">x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>
</code></pre></div></div>

<p>Putting together, we have the algorithm for ROI align:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">roi_align</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="s">"""
  `image` is a 2-D array, representing the input feature map
  `box` is a list of four numbers
  `height` and `width` are the desired spatial size of output feature map
  """</span>
  <span class="n">y_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">box</span>

  <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

  <span class="n">feature_map</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

      <span class="n">y_l</span><span class="p">,</span> <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>
      <span class="n">x_l</span><span class="p">,</span> <span class="n">x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>

      <span class="n">a</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_l</span><span class="p">,</span> <span class="n">x_l</span><span class="p">]</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_l</span><span class="p">,</span> <span class="n">x_h</span><span class="p">]</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_h</span><span class="p">,</span> <span class="n">x_l</span><span class="p">]</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_h</span><span class="p">,</span> <span class="n">x_h</span><span class="p">]</span>

      <span class="n">y_weight</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_l</span>
      <span class="n">x_weight</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_l</span>

      <span class="n">val</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">b</span> <span class="o">*</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">c</span> <span class="o">*</span> <span class="n">y_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">d</span> <span class="o">*</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="n">y_weight</span>

      <span class="n">feature_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_map</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</code></pre></div></div>

<p>We verify the correctness of our implementation by comparing it with the reference implementation. Actually the function <code class="highlighter-rouge">tf.image.crop_and_resize</code> implements ROI align.</p>

<p>Given a 5x6 input feature map</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">array</span><span class="p">([[</span><span class="mf">251.</span><span class="p">,</span>  <span class="mf">44.</span><span class="p">,</span>  <span class="mf">47.</span><span class="p">,</span> <span class="mf">104.</span><span class="p">,</span> <span class="mf">178.</span><span class="p">,</span> <span class="mf">101.</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">93.</span><span class="p">,</span>  <span class="mf">46.</span><span class="p">,</span>  <span class="mf">73.</span><span class="p">,</span> <span class="mf">218.</span><span class="p">,</span> <span class="mf">192.</span><span class="p">,</span>  <span class="mf">22.</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">98.</span><span class="p">,</span>  <span class="mf">85.</span><span class="p">,</span> <span class="mf">122.</span><span class="p">,</span> <span class="mf">144.</span><span class="p">,</span> <span class="mf">172.</span><span class="p">,</span> <span class="mf">151.</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">227.</span><span class="p">,</span>  <span class="mf">22.</span><span class="p">,</span>  <span class="mf">58.</span><span class="p">,</span>  <span class="mf">27.</span><span class="p">,</span> <span class="mf">144.</span><span class="p">,</span> <span class="mf">160.</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">64.</span><span class="p">,</span>  <span class="mf">77.</span><span class="p">,</span> <span class="mf">192.</span><span class="p">,</span>  <span class="mf">18.</span><span class="p">,</span> <span class="mf">253.</span><span class="p">,</span>  <span class="mf">31.</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></div>

<p>and bounding box</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">array</span><span class="p">([[</span><span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">]])</span>
</code></pre></div></div>

<p>we generate the output feature map of shape <code class="highlighter-rouge">[3, 2]</code>.</p>

<p>Our implementation returns</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">array</span><span class="p">([[</span> <span class="mf">85.03</span> <span class="p">,</span> <span class="mf">164.112</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">88.</span>   <span class="p">,</span> <span class="mf">155.95</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">90.97</span> <span class="p">,</span> <span class="mf">147.788</span><span class="p">]])</span>
</code></pre></div></div>

<p>which is the same as what is returned by <code class="highlighter-rouge">tf.image.crop_and_resize</code>.</p>

<h4 id="vectorized-version">Vectorized Version</h4>

<p>Again, we should make our implementation free of python for loops by taking advantage of numpy’s vectorized operation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">roi_align_vectorized</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="s">"""
  `image` is a 2-D array, representing the input feature map
  `box` is a list of four numbers
  `height` and `width` are the desired spatial size of output feature map
  """</span>
  <span class="n">y_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">box</span>

  <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

  <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

  <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

  <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

  <span class="n">y_l</span><span class="p">,</span> <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>
  <span class="n">x_l</span><span class="p">,</span> <span class="n">x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_l</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_l</span><span class="p">]</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_l</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_h</span><span class="p">]</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_h</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_l</span><span class="p">]</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_h</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_h</span><span class="p">]</span>

  <span class="n">y_weight</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_l</span>
  <span class="n">x_weight</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_l</span>

  <span class="n">feature_map</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">b</span> <span class="o">*</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">c</span> <span class="o">*</span> <span class="n">y_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">d</span> <span class="o">*</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="n">y_weight</span>

  <span class="k">return</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="backward-pass-of-roi-align">Backward Pass of ROI Align</h3>

<p>As in the backward pass of Bilinear Resizing, we need to properly route the gradient w.r.t. <code class="highlighter-rouge">a</code>, <code class="highlighter-rouge">b</code>, <code class="highlighter-rouge">c</code>, and <code class="highlighter-rouge">d</code> to a subset of entries in the input <code class="highlighter-rouge">image</code>. And again, the backward pass of ROI Align does not need to use the value of the forward pass.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">roi_align_vectorized_backward</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
  <span class="s">"""
  `image` is a 2-D array, representing the input feature map
  `box` is a list of four numbers
  `height` and `width` are the desired spatial size of output feature map
  `grad` is a 2-D array of shape [height, width], holding gradient backpropped
    from downstream layer. 
  """</span>
  <span class="n">y_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">box</span>
  
  <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

  <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
      <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

  <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

  <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

  <span class="n">y_l</span><span class="p">,</span> <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>
  <span class="n">x_l</span><span class="p">,</span> <span class="n">x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'int32'</span><span class="p">)</span>

  <span class="n">y_weight</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_l</span>
  <span class="n">x_weight</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_l</span>

  <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

  <span class="c1"># gradient wrt `a`, `b`, `c`, `d`
</span>  <span class="n">d_a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
  <span class="n">d_b</span> <span class="o">=</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
  <span class="n">d_c</span> <span class="o">=</span> <span class="n">y_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
  <span class="n">d_d</span> <span class="o">=</span> <span class="n">x_weight</span> <span class="o">*</span> <span class="n">y_weight</span> <span class="o">*</span> <span class="n">grad</span>

  <span class="c1"># [4 * height * width]
</span>  <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">d_a</span><span class="p">,</span> <span class="n">d_b</span><span class="p">,</span> <span class="n">d_c</span><span class="p">,</span> <span class="n">d_d</span><span class="p">])</span>
  <span class="c1"># [4 * height * width]
</span>  <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_l</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_l</span><span class="p">,</span>
                            <span class="n">y_l</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_h</span><span class="p">,</span>
                            <span class="n">y_h</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_l</span><span class="p">,</span>
                            <span class="n">y_h</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">x_h</span><span class="p">])</span>

  <span class="c1"># we must route gradients in `grad` to the correct indices of `image` in 
</span>  <span class="c1"># `indices`
</span>
  <span class="c1"># use numpy's broadcasting rule to generate 2-D array of shape
</span>  <span class="c1"># [4 * height * width, img_height * img_width] 
</span>  <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span>
              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img_height</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
  <span class="n">d_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">grad</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">d_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span><span class="p">)</span>

</code></pre></div></div>

<p>We use some test case to verify the correctness of the backward pass:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">tf</span><span class="o">.</span><span class="n">enable_eager_execution</span><span class="p">()</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">))</span>
  <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">]])</span>
  <span class="n">g</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">crop_and_resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

<span class="n">grad_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">grad_tf</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">grad_val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">grad</span> <span class="o">=</span> <span class="n">roi_align_vectorized_backward</span><span class="p">(</span>
    <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">grad_val</span><span class="p">)</span>

<span class="c1"># compare if `grad_tf` and `grad` are equal.
</span></code></pre></div></div>


  </div><a class="u-url" href="/jekyll/update/2018/07/20/ROIAlign.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">SuperComputer&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">SuperComputer&#39;s Blog</li><li><a class="u-email" href="mailto:ji.chao.stern@gmail.com">ji.chao.stern@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/chao-ji"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">chao-ji</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Democratize ML </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
